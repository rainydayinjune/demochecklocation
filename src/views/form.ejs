<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body class="bg-light">
    <div class="container mt-5">
        <div class="card shadow p-4">
            <h3 class="mb-4 text-center">Thông tin người chấm công</h3>
            <form id="mainForm">
                <div class="mb-3">
                    <label for="name" class="form-label">Tên:</label>
                    <input type="text" id="name" name="name" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label for="add" class="form-label">Địa chỉ:</label>
                    <select id="add" name="add" class="form-select" required>
                        <% addresses.forEach(addr=> { %>
                            <option value="<%= addr %>">
                                <%= addr %>
                            </option>
                            <% }); %>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100">Gửi</button>
            </form>
        </div>
    </div>

    <script>
        document.getElementById("mainForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("name").value;
            const add = document.getElementById("add").value;

            if (!navigator.geolocation) {
                alert("Trình duyệt không hỗ trợ lấy vị trí.");
                return;
            }
            const fixedLocation = {
                lat: 21.317176076842443,
                long: 105.61940891190093
            }
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const currentPos = {
                    lat: pos.coords.latitude,
                    long: pos.coords.longitude
                }
                const lat = pos.coords.latitude;
                const long = pos.coords.longitude;

                try {
                    const res = await fetch(`/form/submit/<%= uuid %>`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name, add, lat, long }),
                    });

                    if (res.redirected) {
                        window.alert("Khoảng cách là: " + getDistance(fixedLocation,currentPos) + " km");
                        window.location.href = res.url;
                    } else {
                        const data = await res.json();

                        window.location.replace(data.link);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Lỗi khi gửi form!");
                }
            }, () => {
                alert("Không thể lấy vị trí thiết bị.");
            });
        });

        function getDistance(p1, p2) {
            const R = 6371; // Radius of the Earth in kilometers
            // Convert degrees to radians
            const toRad = (value) => (value * Math.PI) / 180;

            const lat1 = toRad(p1.lat);
            const lon1 = toRad(p1.long);
            const lat2 = toRad(p2.lat);
            const lon2 = toRad(p2.long);

            // Differences in coordinates
            const dLat = lat2 - lat1;
            const dLon = lon2 - lon1;

            // Haversine formula
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // Distance in km
            return distance;
        }
    </script>
</body>

</html>