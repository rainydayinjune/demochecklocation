<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="css/app.css" rel="stylesheet">
</head>

<body class="bg-light">

    <!-- Common -->
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"> <span
                class="visually-hidden">Loading...</span> </div>
        <p id="loadingText" class="mt-3 text-secondary fw-semibold text-center px-4">
            Đang xử lý... vui lòng chờ giây lát.
        </p>
    </div>
    <div id="toast"></div>
    <!-- End common -->

    <!-- Main form -->
    <div class="container mt-5" style="display:none;" id="mainContainer">
        <div class="card shadow p-4" style="margin-left: auto;margin-right: auto;max-width: 600px;">
            <h3 class="mb-4 text-center">Thông tin người chấm công</h3>
            <form id="mainForm">
                <div class="mb-3">
                    <label for="name" class="form-label">Tên:</label>
                    <input type="text" id="name" name="name" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label for="add" class="form-label">Địa chỉ:</label>
                    <select id="add" name="add" class="form-select" required>
                        <% addresses.forEach(addr=> { %>
                            <option value="<%= addr %>">
                                <%= addr %>
                            </option>
                            <% }); %>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary w-100">Gửi</button>
            </form>
        </div>
    </div>

    <script>
        let userLocation = null;
        let retryInterval = null;

        $(document).ready(function () {

            function requestLocation() {
                if (!navigator.geolocation) {
                    $("#loadingText").text("Trình duyệt của bạn không hỗ trợ lấy vị trí.");
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    function (pos) {
                        userLocation = {
                            lat: pos.coords.latitude,
                            long: pos.coords.longitude
                        };

                        // Nếu có vị trí, dừng retry và hiển thị form
                        clearInterval(retryInterval);
                        $("#loadingOverlay").fadeOut(400, function () {
                            $("#mainContainer").fadeIn(300);
                        });
                    },
                    function () {
                        $("#loadingText").text(
                            "Vui lòng cho phép truy cập vị trí để tiếp tục. Trang sẽ tự thử lại..."
                        );
                    }
                );
            }

            // Gọi ngay lần đầu và sau đó thử lại mỗi 3 giây
            requestLocation();
            retryInterval = setInterval(requestLocation, 3000);

            // Xử lý khi người dùng submit form
            $("#mainForm").on("submit", function (e) {
                e.preventDefault();

                const name = $("#name").val();
                const add = $("#add").val();

                if (!userLocation) {
                    alert("Chưa lấy được vị trí. Vui lòng cho phép truy cập vị trí trước khi gửi.");
                    return;
                }

                $.ajax({
                    url: `/form/submit/<%= uuid %>`,
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        name,
                        add,
                        lat: userLocation.lat,
                        long: userLocation.long
                    }),
                    success: function (data, status, xhr) {
                        const fixedLocation = {
                            lat: 21.317176076842443,
                            long: 105.61940891190093
                        }
                        let distance = getDistance(fixedLocation, userLocation);
                        alert("Khoảng cách là: " + getDistance(fixedLocation, userLocation) + " km");
                        if (xhr.responseJSON.link != null && distance <= 50) {
                            window.location.href = xhr.responseJSON.link;
                        }

                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                        alert("Lỗi khi gửi form!");
                    }
                });
            });
        });

        function getDistance(p1, p2) {
            const R = 6371; // Radius of the Earth in kilometers
            // Convert degrees to radians
            const toRad = (value) => (value * Math.PI) / 180;

            const lat1 = toRad(p1.lat);
            const lon1 = toRad(p1.long);
            const lat2 = toRad(p2.lat);
            const lon2 = toRad(p2.long);

            // Differences in coordinates
            const dLat = lat2 - lat1;
            const dLon = lon2 - lon1;

            // Haversine formula
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c; // Distance in km
            return distance.toFixed(1);
        }
    </script>
</body>

</html>